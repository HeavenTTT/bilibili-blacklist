#!/usr/bin/env node

/**
 * Bilibili-BlackList - æ„å»ºè„šæœ¬
 * å°†æ¨¡å—åŒ–çš„ä»£ç æ‰“åŒ…æˆå•ä¸ªç”¨æˆ·è„šæœ¬æ–‡ä»¶
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// è¯»å–ç”¨æˆ·è„šæœ¬å¤´éƒ¨
const scriptHeader = fs.readFileSync('./scripts/bilibili-blacklist.user.js', 'utf8');
const headerEndIndex = scriptHeader.indexOf('(function ()');
const header = scriptHeader.substring(0, headerEndIndex);

// è¯»å–æ‰€æœ‰æ¨¡å—å¹¶åˆå¹¶
const modules = [
  './src/utils/helpers.js',
  './src/storage/manager.js',
  './src/core/blocker.js',
  './src/ui/manager.js',
  './src/adblock/main.js',
  './src/observers/page-observers.js',
  './src/main.js'
];

let combinedCode = header;

// æ·»åŠ  IIFE åŒ…è£…å¼€å§‹
combinedCode += '\n(function () {\n  "use strict";\n\n';

// æ·»åŠ æ³¨é‡Šåˆ†éš”
combinedCode += '  /* ================ å·¥å…·å‡½æ•°æ¨¡å— ================ */\n';
const utilsCode = fs.readFileSync(modules[0], 'utf8');
// ç§»é™¤import/exportè¯­å¥ï¼Œå°†å…¶è½¬æ¢ä¸ºå‡½æ•°å®šä¹‰
combinedCode += utilsCode
  .replace(/export\s+function\s+/g, '  function ')
  .replace(/export\s+{([^}]+)}/g, '') // ç§»é™¤export { ... }
  .replace(/import\s+{([^}]+)}\s+from\s+['"][^'"]+['"]\s*/g, '') // ç§»é™¤importè¯­å¥
  .replace(/export\s+class\s+/g, '  class ');

// æ·»åŠ æ³¨é‡Šåˆ†éš”
combinedCode += '\n  /* ================ å­˜å‚¨ç®¡ç†æ¨¡å— ================ */\n';
const storageCode = fs.readFileSync(modules[1], 'utf8');
combinedCode += storageCode
  .replace(/export\s+class\s+/g, '  class ')
  .replace(/import\s+{([^}]+)}\s+from\s+['"][^'"]+['"]\s*/g, '');

// æ·»åŠ æ³¨é‡Šåˆ†éš”
combinedCode += '\n  /* ================ æ ¸å¿ƒå±è”½æ¨¡å— ================ */\n';
const coreCode = fs.readFileSync(modules[2], 'utf8');
combinedCode += coreCode
  .replace(/import\s+{([^}]+)}\s+from\s+['"][^'"]+['"]\s*/g, '')
  .replace(/export\s+class\s+/g, '  class ');

// æ·»åŠ æ³¨é‡Šåˆ†éš”
combinedCode += '\n  /* ================ UIç®¡ç†æ¨¡å— ================ */\n';
const uiCode = fs.readFileSync(modules[3], 'utf8');
combinedCode += uiCode
  .replace(/import\s+{([^}]+)}\s+from\s+['"][^'"]+['"]\s*/g, '')
  .replace(/export\s+class\s+/g, '  class ');

// æ·»åŠ æ³¨é‡Šåˆ†éš”
combinedCode += '\n  /* ================ å¹¿å‘Šå±è”½æ¨¡å— ================ */\n';
const adblockCode = fs.readFileSync(modules[4], 'utf8');
combinedCode += adblockCode
  .replace(/import\s+{([^}]+)}\s+from\s+['"][^'"]+['"]\s*/g, '')
  .replace(/export\s+class\s+/g, '  class ');

// æ·»åŠ æ³¨é‡Šåˆ†éš”
combinedCode += '\n  /* ================ é¡µé¢è§‚å¯Ÿå™¨æ¨¡å— ================ */\n';
const observersCode = fs.readFileSync(modules[5], 'utf8');
combinedCode += observersCode
  .replace(/import\s+{([^}]+)}\s+from\s+['"][^'"]+['"]\s*/g, '')
  .replace(/export\s+class\s+/g, '  class ');

// æ·»åŠ æ³¨é‡Šåˆ†éš”
combinedCode += '\n  /* ================ ä¸»å…¥å£æ¨¡å— ================ */\n';
const mainCode = fs.readFileSync(modules[6], 'utf8');
combinedCode += mainCode
  .replace(/import\s+{([^}]+)}\s+from\s+['"][^'"]+['"]\s*/g, '')
  .replace(/export\s+{([^}]+)}/g, ''); // ç§»é™¤exportè¯­å¥

// æ·»åŠ  IIFE åŒ…è£…ç»“æŸ
combinedCode += '\n  /*\n   * Bilibili-BlackList -- Bilibili UPå±è”½æ’ä»¶\n   * é‡æ„ç‰ˆæœ¬ - æ¨¡å—åŒ–è®¾è®¡ï¼Œæé«˜å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§\n   * this script is mainly generated by AI, the author doesn\'t know JavaScript at all, if there are bugs, please contact Gemini / ChatGPT / DeepSeek\n   * æ„Ÿè°¢ä½ çš„ä½¿ç”¨\n   * Thank you for using this script\n   */\n\n  // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—\n  const storageManager = new StorageManager();\n  const config = storageManager.getGlobalConfig();\n  const blocker = new CoreBlocker(storageManager, config);\n  const uiManager = new UIManager(storageManager, blocker);\n  const pageObserver = new PageObserver(blocker, uiManager, storageManager);\n  const adBlocker = new AdBlocker(storageManager, blocker);\n\n  // æ·»åŠ å…¨å±€æ ·å¼\n  uiManager.addGlobalStyles();\n\n  // è®¾ç½®é¡µé¢å¯è§æ€§ç›‘å¬å™¨\n  pageObserver.setupPageVisibilityListener();\n\n  // ç›‘å¬DOMContentLoadedå¹¶æ£€æŸ¥readyStateä»¥è¿›è¡Œæ—©æœŸåˆå§‹åŒ–\n  document.addEventListener("DOMContentLoaded", () => {\n    pageObserver.initializeObserver();\n  });\n  \n  if (\n    document.readyState === "complete" ||\n    document.readyState === "interactive"\n  ) {\n    pageObserver.initializeObserver();\n  }\n\n  // æš´éœ²ä¸€äº›åŠŸèƒ½åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯•\n  window.BilibiliBlackList = {\n    storageManager,\n    blocker,\n    uiManager,\n    pageObserver,\n    adBlocker,\n    refreshUI: () => {\n      uiManager.refreshAllPanelTabs();\n      uiManager.refreshBlockCountDisplay();\n    }\n  };\n\n  console.log("[bilibili-blacklist] é‡æ„ç‰ˆæœ¬å·²åŠ è½½ï¼Œæ¨¡å—åŒ–è®¾è®¡ ğŸš€");\n\n})();';

// å†™å…¥æ„å»ºåçš„æ–‡ä»¶
fs.writeFileSync('./dist/bilibili-blacklist.user.js', combinedCode);
console.log('æ„å»ºå®Œæˆï¼ç”Ÿæˆçš„æ–‡ä»¶: ./dist/bilibili-blacklist.user.js');