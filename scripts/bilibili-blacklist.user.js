// ==UserScript==
// @name         Bilibili-BlackList
// @namespace    https://github.com/HeavenTTT/bilibili-blacklist
// @version      1.1.7
// @author       HeavenTTT
// @description  Bilibili UPå±è”½æ’ä»¶ - å±è”½UPä¸»è§†é¢‘å¡ç‰‡ï¼Œæ”¯æŒç²¾ç¡®åŒ¹é…å’Œæ­£åˆ™åŒ¹é…ï¼Œæ”¯æŒè§†é¢‘é¡µé¢ã€åˆ†ç±»é¡µé¢ã€æœç´¢é¡µé¢ç­‰ã€‚
// @match        *://*.bilibili.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @icon         https://www.bilibili.com/favicon.ico
// @license      MIT
// ==/UserScript==

(function () {
  "use strict";
  /*
   * Bilibili-BlackList -- Bilibili UPå±è”½æ’ä»¶
   * è„šæœ¬å¤§éƒ¨åˆ†ä»£ç ç”±AIç”Ÿæˆï¼Œä½œè€…ä¸€ç‚¹éƒ½ä¸æ‡‚JavaScriptï¼Œå‡ºç°bugè¯·è”ç³»Gemini / ChatGPT / DeepSeek
   * this script is mainly generated by AI, the author doesn't know JavaScript at all, if there are bugs, please contact Gemini / ChatGPT / DeepSeek
   * æ„Ÿè°¢ä½ çš„ä½¿ç”¨
   * Thank you for using this script
   *
   * æœ¬æ®µæ³¨é‡Šä¸ºVS code è‡ªåŠ¨ç”Ÿæˆ this is a comment generated by VS code
   */
  // ä»å­˜å‚¨ä¸­è·å–é»‘åå•
  // é»˜è®¤ç²¾ç¡®åŒ¹é…é»‘åå•ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
  let exactBlacklist = GM_getValue("exactBlacklist", [
    "ç»åŒºé›¶",
    "å´©åæ˜Ÿç©¹é“é“",
    "å´©å3",
    "åŸç¥",
    "ç±³å“ˆæ¸¸miHoYo",
  ]);
  // é»˜è®¤æ­£åˆ™åŒ¹é…é»‘åå•
  let regexBlacklist = GM_getValue("regexBlacklist", [
    "ç‹è€…è£è€€",
    "å’Œå¹³ç²¾è‹±",
    "PUBG",
    "ç»åœ°æ±‚ç”Ÿ",
    "åƒé¸¡",
  ]);
  // æ ‡ç­¾å±è”½é»‘åå•
  let tNameBlacklist = GM_getValue("tNameBlacklist", ["æ‰‹æœºæ¸¸æˆ"]);
  let globalConfig = GM_getValue("globalConfig", {
    flagInfo: true,
    flagAD: true,
    flagTName: true,
    flagCM: true,
    flagKirby: false,
    processQueueInterval: 500, // å•ä½ ms
  });
  // ä¿å­˜é»‘åå•åˆ°å­˜å‚¨
  function saveBlacklists() {
    GM_setValue("exactBlacklist", exactBlacklist);
    GM_setValue("regexBlacklist", regexBlacklist);
    GM_setValue("tNameBlacklist", tNameBlacklist);
  }
  function saveGlobalConfig() {
    GM_setValue("globalConfig", globalConfig);
  }
  //å¼€å‘ç”¨æ—¥å¿—ï¼Œbugï¼šè¿è¡Œè¯¥å‡½æ•°åï¼Œè„šæœ¬æ‰èƒ½æ­£å¸¸å·¥ä½œï¼ŒåŸå› æœªçŸ¥ï¼Œæœ¬æ’ä»¶ä¾èµ–æ­¤bugè¿è¡Œï¼Œè¯·å‹¿åˆ é™¤ä»»ä½•å¼•ç”¨
  function Devlog(...args) {
    if (GM_info.script.version === "Dev") console.log("[Devlog]", ...args);
  }
  //#region æ ¸å¿ƒåŠŸèƒ½ - å±è”½è§†é¢‘å¡ç‰‡
  let isShowAll = false; // æ˜¯å¦æ˜¾ç¤ºå…¨éƒ¨è§†é¢‘å¡ç‰‡
  let isBlocking = false; // æ˜¯å¦æ­£åœ¨æ‰§è¡Œå±è”½æ“ä½œ
  let lastBlockTime = 0; // ä¸Šæ¬¡æ‰§è¡Œå±è”½çš„æ—¶é—´æˆ³
  let blockedCards = new Set(); // å­˜å‚¨å·²å±è”½çš„è§†é¢‘å¡ç‰‡å…ƒç´ 
  let processedCards = new WeakSet(); // è®°å½•å·²å¤„ç†è¿‡çš„å¡ç‰‡(é¿å…é‡å¤å¤„ç†)
  //ç»™å¡ç‰‡æ·»åŠ å±è”½æŒ‰é’®
  function cardAddBlockcContainer(upName, card) {
    if (!card.querySelector("bilibili-blacklist-block-container")) {
      const container = document.createElement("div");
      container.classList.add("bilibili-blacklist-block-container");
      if (!card.querySelector(".bilibili-blacklist-block-btn")) {
        // åˆ›å»ºå±è”½æŒ‰é’®
        if (isVideoPage()) {
          // å¦‚æœæ˜¯è§†é¢‘é¡µé¢
          if (isInit) {
            const blockButton = createBlockButton(upName, card);
            card.querySelector(".card-box").style.position = "relative";
            card.querySelector(".card-box").appendChild(container);
            container.appendChild(blockButton);
          }
        } else if (isCategoryPage()) {
          // å¦‚æœæ˜¯åˆ†ç±»é¡µé¢
          const blockButton = createBlockButton(upName, card); // åˆ›å»ºå±è”½æŒ‰é’®
          card.querySelector(".bili-video-card").appendChild(container); // å°†æŒ‰é’®æ·»åŠ åˆ°å¡ç‰‡ä¸­ä¿¡æ¯ä¸­
          container.appendChild(blockButton); // å°†æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨ä¸­
        } else {
          const blockButton = createBlockButton(upName, card); // åˆ›å»ºå±è”½æŒ‰é’®
          card.appendChild(container); // å°†æŒ‰é’®æ·»åŠ åˆ°å¡ç‰‡ä¸­
          container.appendChild(blockButton); // å°†æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨ä¸­
        }
      }
    }
  }
  //éšè—å¡ç‰‡
  function hideCard(card) {
    card = getRealBlockCard(card);
    if (!blockedCards.has(card)) {
      blockedCards.add(card); // å°†å¡ç‰‡æ·»åŠ åˆ°å·²å±è”½åˆ—è¡¨
      if (globalConfig.flagKirby) {
        addKirbyOverlay(card); // æ·»åŠ é®ç½©å±‚
      }
    }
    if (!isShowAll) {
      if (!globalConfig.flagKirby) {
        card.style.display = "none"; // éšè—å¡ç‰‡
      }
    }
  }
  function getRealBlockCard(card) {
    if (isSearchPage()) {
      // å¦‚æœæ˜¯æœç´¢é¡µé¢ -> éšè—çˆ¶å…ƒç´ 
      card = card.parentElement; // è·å–çˆ¶å…ƒç´ 
    }
    if (isMainPage()) {
      // å¦‚æœæ˜¯ä¸»é¡µ
      if (card.parentElement.classList.contains("bili-feed-card")) {
        // å¦‚æœçˆ¶å…ƒç´ æ˜¯feed-card
        card = card.parentElement; // è·å–çˆ¶å…ƒç´ 
        if (card.parentElement.classList.contains("feed-card")) {
          card = card.parentElement; // è·å–çˆ¶å…ƒç´ 
        }
      }
    }
    return card;
  }
  /// æŸ¥æ‰¾æ‰€æœ‰è§†é¢‘å¡ç‰‡
  function querySelectorAllVideoCard(selector) {
    return document.querySelectorAll(selector);
  }
  /// å±è”½è§†é¢‘å¡ç‰‡
  function BlockCard() {
    const now = Date.now();
    if (isBlocking || now - lastBlockTime < 1000) {
      return;
    }
    isBlocking = true;
    lastBlockTime = now;
    try {
      let cards = null;
      if (isMainPage()) {
        cards = querySelectorAllVideoCard(".bili-video-card");
      } else if (isVideoPage()) {
        cards = querySelectorAllVideoCard(".video-page-card-small");
      } else if (isCategoryPage()) {
        cards = querySelectorAllVideoCard(".feed-card");
      } else if (isSearchPage()) {
        cards = querySelectorAllVideoCard(".bili-video-card");
      } else return; // å¦‚æœä¸æ˜¯è§†é¢‘é¡µé¢ï¼Œåˆ™ä¸æ‰§è¡Œå±è”½æ“ä½œ
      cards.forEach((card) => {
        if (processedCards.has(card)) {
          return; // å¦‚æœå¡ç‰‡å·²ç»å¤„ç†è¿‡ï¼Œåˆ™è·³è¿‡
        }
        addButtontTNameQueue(card);
        // è·å–è§†é¢‘ä¿¡æ¯
        const { upName, title } = GetVideoInfo(card);
        if (upName && title) {
          processedCards.add(card); // å°†å¡ç‰‡æ ‡è®°ä¸ºå·²å¤„ç†
          cardAddBlockcContainer(upName, card); // æ·»åŠ å±è”½æŒ‰é’®

          // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
          if (isBlacklisted(upName, title) && globalConfig.flagInfo) {
            // å¦‚æœåœ¨é»‘åå•ä¸­ï¼Œåˆ™éšè—å¡ç‰‡
            hideCard(card);
          }
          if (globalConfig.flagTName) {
            if (isCardBlacklistTName(card)) {
              hideCard(card);
            }
          }
        } else {
          //console.warn("æœªæ‰¾åˆ°UPä¸»åç§°æˆ–è§†é¢‘æ ‡é¢˜ï¼Œè·³è¿‡å±è”½:", card);
        }
      });
      refreshBlockCountDisplay();
      FixedMainPage(); // ä¿®æ­£ä¸»é¡µçš„é”™ä½é—®é¢˜
    } finally {
      isBlocking = false; // é‡ç½®å±è”½çŠ¶æ€
    }
  }
  //ä¿®æ­£ä¸»é¡µçš„é”™ä½é—®é¢˜
  function FixedMainPage() {
    if (!isMainPage()) return; // ä»…åœ¨ä¸»é¡µæ‰§è¡Œ
    const container = document.querySelector(
      ".recommended-container_floor-aside .container" // æ¨èè§†é¢‘å®¹å™¨
    );
    // æ£€æŸ¥çˆ¶å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (container) {
      const children = container.children; // è¿™æ˜¯ä¸€ä¸ª HTMLCollection
      let visableindex = 0; // å¯è§å­å…ƒç´ çš„ç´¢å¼•
      for (let i = 0; i < children.length; i++) {
        const child = children[i];
        if (child.style.display !== "none") {
          if (visableindex <= 6) {
            child.style.marginTop = "0px";
          } else if (visableindex < 12) {
            child.style.marginTop = "24px";
          } else {
            break; // å¦‚æœå¯è§å­å…ƒç´ è¶…è¿‡10ä¸ªï¼Œåˆ™åœæ­¢å¤„ç†
          }
          visableindex++; // ç»Ÿè®¡å¯è§å­å…ƒç´ çš„æ•°é‡
        }
      }
    }
  }
  // æ›´æ–°å±è”½è®¡æ•°æ˜¾ç¤º
  function refreshBlockCountDisplay() {
    if (blockCountDiv) {
      blockCountDiv.textContent = `${blockedCards.size}`; // æ›´æ–°å³ä¾§å¯¼èˆªæ çš„å±è”½è®¡æ•°
    }
    // æ›´æ–°é¢æ¿æ ‡é¢˜ï¼ˆå¦‚æœé¢æ¿å·²æ‰“å¼€ï¼‰
    //const panel = document.getElementById("bilibili-blacklist-panel");
    if (blockTitle) {
      blockTitle.textContent = `å·²å±è”½è§†é¢‘ (${blockedCards.size})`; // æ›´æ–°é¢æ¿æ ‡é¢˜
    }
  }
  // æš‚æ—¶å–æ¶ˆå±è”½/æ¢å¤å±è”½åŠŸèƒ½
  function toggleShowAll() {
    isShowAll = !isShowAll;
    blockedCards.forEach((card) => {
      if (globalConfig.flagKirby) {
        card.querySelector("#bilibili-blacklist-kirby").style.display =
          isShowAll ? "none" : "block";
      } else {
        card.style.display = isShowAll ? "block" : "none";
      }
    });
    btnTempUnblock.textContent = isShowAll ? "æ¢å¤å±è”½" : "å–æ¶ˆå±è”½";
    btnTempUnblock.style.background = isShowAll ? "#dddddd" : "#fb7299";
    // ä¸éœ€è¦æ›´æ–°blockCountï¼Œå› ä¸ºæ€»æ•°æ²¡æœ‰å˜åŒ–
  }
  const selectorUpName = [
    ".bili-video-card__info--author", // ä¸»é¡µ
    ".bili-video-card__author", // åˆ†ç±»é¡µé¢--> span title
    ".name", // æ’­æ”¾é¡µé¢
  ];
  const selectorTitle = [
    ".bili-video-card__info--tit", // ä¸»é¡µ
    ".bili-video-card__title", // åˆ†ç±»é¡µé¢--> span title
    ".title", // æ’­æ”¾é¡µé¢
  ];
  //è·å–è§†é¢‘ä¿¡æ¯ -UPä¸»åç§° -è§†é¢‘æ ‡é¢˜
  function GetVideoInfo(card) {
    let upName = "";
    let title = "";
    //if (card.style.display === "none") return { upName, title }; // å¦‚æœå¡ç‰‡å·²è¢«éšè—ï¼Œåˆ™ç›´æ¥è¿”å›ç©ºä¿¡æ¯
    const upNameElement = card.querySelectorAll(selectorUpName.join(", ")); // ä½¿ç”¨é€—å·åˆ†éš”çš„é€‰æ‹©å™¨
    if (upNameElement.length > 0) {
      upName = upNameElement[0].textContent.trim(); // è·å–ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„å…ƒç´ çš„å†…å®¹ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
      //å¤„ç†åˆ†ç±»é¡µé¢çš„UPä¸»åç§°
      if (isCategoryPage()) {
        upName = upName.split(" Â· ")[0].trim();
      }
    }
    const titleElement = card.querySelectorAll(selectorTitle.join(", ")); // ä½¿ç”¨é€—å·åˆ†éš”çš„é€‰æ‹©å™¨
    if (titleElement.length > 0) {
      title = titleElement[0].textContent.trim(); // è·å–ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„å…ƒç´ çš„å†…å®¹ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
    }
    return { upName, title };
  }

  function isBlacklisted(upName, title) {
    // ç²¾ç¡®åŒ¹é…é»‘åå•ï¼ˆæ— è§†å¤§å°å†™ï¼‰
    // å°† upName è½¬æ¢ä¸ºå°å†™ï¼Œç„¶åä¸é»‘åå•ä¸­çš„æ¯ä¸ªé¡¹çš„å°å†™è¿›è¡Œæ¯”è¾ƒ
    const lowerCaseUpName = upName.toLowerCase();
    if (exactBlacklist.some((item) => item.toLowerCase() === lowerCaseUpName)) {
      return true;
    }

    // æ­£åˆ™åŒ¹é…é»‘åå•ï¼ˆæ— è§†å¤§å°å†™ï¼‰
    // ä¸ºæ­£åˆ™è¡¨è¾¾å¼æ·»åŠ  'i' æ ‡å¿—ï¼Œè¡¨ç¤ºå¿½ç•¥å¤§å°å†™
    if (regexBlacklist.some((regex) => new RegExp(regex, "i").test(upName))) {
      return true;
    }
    if (regexBlacklist.some((regex) => new RegExp(regex, "i").test(title))) {
      return true;
    }
    return false; // ä¸åœ¨é»‘åå•ä¸­
  }
  /// æ·»åŠ UPä¸»åˆ°ç²¾ç¡®é»‘åå•å¹¶åˆ·æ–°é¡µé¢
  function addToExactBlacklist(upName, cardElement = null) {
    try {
      if (!upName) return;
      if (!exactBlacklist.includes(upName)) {
        exactBlacklist.push(upName);
        saveBlacklists();
        refreshAllTabs();
        if (cardElement) {
          hideCard(cardElement); // éšè—å½“å‰å¡ç‰‡
        }
      }
    } catch (e) {
      console.error("[bilibili-blacklist] æ·»åŠ é»‘åå•å‡ºé”™:", e);
    }
  }
  function removeFromExactBlacklist(upName) {
    try {
      if (exactBlacklist.includes(upName)) {
        const index = exactBlacklist.indexOf(upName);
        exactBlacklist.splice(index, 1);
        saveBlacklists();
        refreshExactList();
      }
    } catch (e) {
      console.error("[bilibili-blacklist] ç§»é™¤é»‘åå•å‡ºé”™:", e);
    } finally {
      //BlockCard();
    }
  }
  function addToTNameBlacklist(tname, cardElement = null) {
    try {
      if (!tname) {
        return;
      }
      if (!tNameBlacklist.includes(tname)) {
        tNameBlacklist.push(tname);
        saveBlacklists();
        refreshAllTabs();
        if (cardElement) {
          hideCard(cardElement); //éšè—å¡ç‰‡
        }
      }
    } catch (e) {
      console.error("[bilibili-blacklist] æ·»åŠ æ ‡ç­¾é»‘åå•å‡ºé”™:", e);
    }
  }
  function removeFromTNameBlacklist(tname) {
    try {
      if (tNameBlacklist.includes(tname)) {
        const index = tNameBlacklist.indexOf(tname);
        tNameBlacklist.splice(index, 1);
        saveBlacklists();
        refreshTagNameList();
      }
    } catch (e) {
      console.error("[bilibili-blacklist] ç§»é™¤æ ‡ç­¾é»‘åå•å‡ºé”™:", e);
    }
  }
  //#endregion

  //#region Bvå·ä»¥åŠè§†é¢‘ä¿¡æ¯
  let cardSequenceGetJson = new Set(); // å­˜å‚¨å¡ç‰‡é˜Ÿåˆ—
  let isProcessingCardQueue = false; // æ˜¯å¦æ­£åœ¨å¤„ç†é˜Ÿåˆ—
  let isPageActive = true; // é¡µé¢æ˜¯å¦å¯è§
  function getCardBv(card) {
    const bvElement = card.querySelector("a");
    if (!bvElement) {
      return null;
    }
    try {
      const link = bvElement.getAttribute("href");
      if (!link) {
        return null;
      } else {
        //åˆ¤æ–­é“¾æ¥æ˜¯ä¸æ˜¯cm.bilili
        if (link.match(/cm.bilibili.com/) && globalConfig.flagCM) {
          hideCard(card);
          return null;
        }
        const bv = link.match(/BV\w+/);
        return bv[0];
      }
    } catch (e) {
      return null;
    }
  }

  async function getBilibiliVideoAPI(bvid) {
    if (bvid.length >= 24) {
      return null;
    }
    const url = `https://api.bilibili.com/x/web-interface/view?bvid=${bvid}`;
    try {
      const response = await fetch(url);
      const json = await response.json();
      if (json.code === 0) {
        return json.data;
      } else {
        return null;
      }
    } catch (error) {
      console.error("[bilibili-blacklist] API è¯·æ±‚å¤±è´¥:", error);
    }
  }
  function isCardBlacklistTName(card) {
    const tnameGroup = card.querySelector(".bilibili-blacklist-tname-group");
    if (tnameGroup) {
      const tnameElements = tnameGroup.querySelectorAll(
        ".bilibili-blacklist-tname"
      );
      for (const tnameElement of tnameElements) {
        const tname = tnameElement.textContent.trim();
        if (tNameBlacklist.includes(tname)) {
          return true;
        }
      }
    }
    return false;
  }
  // é˜Ÿåˆ—å¤„ç†å‡½æ•°
  let cardSequenceGetJsonDone = new Set(); // å­˜å‚¨å¡ç‰‡é˜Ÿåˆ—
  async function processCardTNameQueue() {
    if (isProcessingCardQueue) return;
    isProcessingCardQueue = true;

    while (cardSequenceGetJson.size > 0) {
      if (!isPageActive) {
        await sleep(1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
        continue; // ä¸å¤„ç†å½“å‰å¡ç‰‡ï¼Œé‡æ–°åˆ¤æ–­
      }
      const iterator = cardSequenceGetJson.values();
      const card = iterator.next().value;
      cardSequenceGetJson.delete(card);
      if (!card) continue;
      if (cardSequenceGetJsonDone.has(card)) {
        //("å¡ç‰‡å·²å¤„ç†è¿‡" + card.textContent);
        continue;
      }
      const bv = getCardBv(card);
      if (!bv) continue;
      const container = card.querySelector(
        ".bilibili-blacklist-block-container"
      );
      if (!container) {
        //Devlog("æœªæ‰¾åˆ°å®¹å™¨" + card.textContent);
        continue;
      }
      cardSequenceGetJsonDone.add(card);
      const data = await getBilibiliVideoAPI(bv);
      if (!data) {
        // Devlog("æœªæ‰¾åˆ°æ•°æ®" + card.textContent);
        cardSequenceGetJsonDone.remove(card);
        continue;
      }
      // å¦‚æœ card å·²ç»å¤„ç†è¿‡ tname groupï¼Œè·³è¿‡
      // æœ€ç»ˆç¡®è®¤
      if (!card.querySelector(".bilibili-blacklist-tname-group")) {
        // åˆ›å»º tname group
        const tnameGroup = document.createElement("div");
        tnameGroup.className = "bilibili-blacklist-tname-group";

        let hasTname = false;
        // æ·»åŠ ä¸€çº§ tname
        if (data.tname) {
          //Devlog(`å¤„ç† BV: ${bv} - åˆ†ç±»: ${data.tname}`);
          const btn = createTNameBlockButton(data.tname, card);
          tnameGroup.appendChild(btn);
          hasTname = true;
        }

        // æ·»åŠ äºŒçº§ tname_v2
        if (data.tname_v2) {
          //Devlog(`å¤„ç† BV: ${bv} - åˆ†ç±»2: ${data.tname_v2}`);
          const tnameElement = createTNameBlockButton(data.tname_v2, card);
          tnameGroup.appendChild(tnameElement);
          hasTname = true;
        }
        // åªæœ‰æœ‰ tname æ‰ append groupï¼Œé¿å…æ’å…¥ç©ºå®¹å™¨
        if (hasTname) {
          container.appendChild(tnameGroup);
        }
      }

      await sleep(globalConfig.processQueueInterval || 100);
    }
    isProcessingCardQueue = false;
  }
  function addButtontTNameQueue(card) {
    if (!globalConfig.flagTName) return;
    const bv = getCardBv(card);
    if (!bv) return;
    // æ£€æŸ¥æ˜¯å¦å·²åœ¨å¤„ç†ä¸­æˆ–å·²æœ‰æ ‡ç­¾ç»„
    if (card.querySelector(".bilibili-blacklist-tname-group")) {
      return;
    }
    // æ£€æŸ¥æ˜¯å¦å·²åœ¨é˜Ÿåˆ—ä¸­
    if (cardSequenceGetJson.has(card)) {
      return;
    }
    cardSequenceGetJson.add(card);
    if (!isProcessingCardQueue) {
      processCardTNameQueue();
    }
  }
  //
  function sleep(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }
  // é¡µé¢å¯è§æ€§ç›‘å¬
  document.addEventListener("visibilitychange", () => {
    isPageActive = !document.hidden;
    //Devlog(`é¡µé¢å¯è§çŠ¶æ€æ”¹å˜: ${isPageActive ? "æ´»åŠ¨" : "éšè—"}`);
  });

  // çª—å£ç„¦ç‚¹ç›‘å¬
  window.addEventListener("focus", () => {
    isPageActive = true;
    //Devlog("çª—å£è·å¾—ç„¦ç‚¹");
  });

  window.addEventListener("blur", () => {
    isPageActive = false;
    //Devlog("çª—å£å¤±å»ç„¦ç‚¹");
  });

  //#endregion
  //#region é¡µé¢ä¿®æ”¹
  //åˆ›å»ºå±è”½æŒ‰é’®ï¼ˆæ‚¬åœåœ¨è§†é¢‘å¡ç‰‡ä¸Šæ—¶æ˜¾ç¤ºï¼‰
  function createBlockButton(upName, cardElement) {
    const btn = document.createElement("div");
    btn.className = "bilibili-blacklist-block-btn";
    btn.innerHTML = "å±è”½";
    btn.title = `å±è”½: ${upName}`;
    // å±è”½æŒ‰é’®æ ·å¼
    // ç‚¹å‡»æ—¶æ·»åŠ åˆ°é»‘åå•
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
      addToExactBlacklist(upName, cardElement);
    });

    return btn;
  }
  function createTNameBlockButton(tName, cardElement) {
    const btn = document.createElement("span");
    btn.className = "bilibili-blacklist-tname";
    btn.innerHTML = `${tName}`;
    btn.title = `å±è”½: ${tName}`;

    // å±è”½æŒ‰é’®æ ·å¼
    // ç‚¹å‡»æ—¶æ·»åŠ åˆ°é»‘åå•
    btn.addEventListener("click", (e) => {
      e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
      addToTNameBlacklist(tName, cardElement);
    });

    return btn;
  }
  // åœ¨å³ä¾§å¯¼èˆªæ æ·»åŠ é»‘åå•ç®¡ç†æŒ‰é’®
  let blockCountDiv = null;
  function addBlacklistManagerButton() {
    if (isVideoPage()) {
      return;
    }
    const rightEntry = document.querySelector(".right-entry");
    if (!rightEntry) {
      console.warn("[bilibili-blacklist] æœªæ‰¾åˆ°å³ä¾§å¯¼èˆªæ ");
      return;
    } else if (!rightEntry.querySelector("#bilibili-blacklist-manager")) {
      //else if(rightEntry.getElementById('bilibili-blacklist-manager')){
      const li = document.createElement("li");
      li.id = "bilibili-blacklist-manager";
      li.style.cursor = "pointer";
      li.className = "v-popover-wrap";

      const btn = document.createElement("div");
      btn.className = "right-entry-item";
      btn.style.display = "flex";
      btn.style.flexDirection = "column";
      btn.style.alignItems = "center";
      btn.style.justifyContent = "center";

      // å¯çˆ±çš„å¡æ¯”å›¾æ ‡SVG
      const icon = document.createElement("div");
      icon.className = "right-entry__outside";
      icon.innerHTML = getKirbySVG();
      //icon.style.color = '#fb7299'; // Bç«™ç²‰è‰²
      icon.style.marginBottom = "-5px";
      blockCountDiv = document.createElement("span");
      //const text = document.createElement('div');
      blockCountDiv.textContent = `0`;
      btn.appendChild(icon);
      btn.appendChild(blockCountDiv);
      li.appendChild(btn);

      // åœ¨å¯¼èˆªä¸­æ’å…¥æŒ‰é’®
      if (rightEntry.children.length > 1) {
        rightEntry.insertBefore(li, rightEntry.children[1]);
      } else {
        rightEntry.appendChild(li);
      }
      // ç‚¹å‡»æŒ‰é’®æ—¶æ˜¾ç¤ºé¢æ¿
      li.addEventListener("click", () => {
        if (managerPanel.style.display === "none") {
          managerPanel.style.display = "flex";
        } else {
          managerPanel.style.display = "none";
        }
      });
    }
  }
  // åˆ›å»ºé»‘åå•ç®¡ç†é¢æ¿
  let btnTempUnblock;
  let managerPanel;
  let exactList; //ç²¾ç¡®åŒ¹é…åˆ—è¡¨
  let regexList; //æ­£åˆ™åŒ¹é…åˆ—è¡¨
  let tNameList; //tnameåŒ¹é…åˆ—è¡¨
  let configList; //é…ç½®åˆ—è¡¨
  let blockTitle;

  // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºæŒ‰é’®
  function createButton(text, bgColor, onClick) {
    const button = document.createElement("button");
    button.textContent = text;
    button.style.padding = "4px 8px";
    button.style.background = bgColor;
    button.style.color = "#fff";
    button.style.border = "none";
    button.style.borderRadius = "4px";
    button.style.cursor = "pointer";
    button.addEventListener("click", onClick);
    return button;
  }

  // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºåˆ—è¡¨é¡¹
  function createListItem(contentText, onRemoveClick, isRegex = false) {
    const item = document.createElement("li");
    item.style.display = "flex";
    item.style.justifyContent = "space-between";
    item.style.alignItems = "center";
    item.style.padding = "8px 0";
    item.style.borderBottom = "1px solid #f1f2f3";

    const content = document.createElement("span");
    content.textContent = contentText;
    content.style.flex = "1";
    const removeBtn = createButton("ç§»é™¤", "#f56c6c", onRemoveClick);

    item.appendChild(content);
    item.appendChild(removeBtn);
    return item;
  }

  // æ›´æ–°ç²¾ç¡®åŒ¹é…åˆ—è¡¨
  function refreshExactList() {
    if (!exactList) {
      if (!isBlacklistPanelCreated()) {
        return;
      }
      exactList = document.querySelector("#bilibili-blacklist-exact-list");
      if (!exactList) {
        console.warn("[Bilibili-Blacklist] exactList æœªå®šä¹‰");
        return;
      }
    }
    exactList.innerHTML = "";
    exactBlacklist.forEach((upName) => {
      const item = createListItem(upName, () => {
        removeFromExactBlacklist(upName);
        //BlockCard(); //æ›´æ–°å±è”½å¡ç‰‡
      });
      exactList.appendChild(item);
    });
    Array.from(exactList.children)
      .reverse()
      .forEach((item) => exactList.appendChild(item));

    if (exactBlacklist.length === 0) {
      const empty = document.createElement("div");
      empty.textContent = "æš‚æ— ç²¾ç¡®åŒ¹é…å±è”½UPä¸»";
      empty.style.textAlign = "center";
      empty.style.padding = "16px";
      empty.style.color = "#999";
      exactList.appendChild(empty);
    }
  }

  // æ›´æ–°æ­£åˆ™åŒ¹é…åˆ—è¡¨
  function refreshRegexList() {
    if (!regexList) return;
    regexList.innerHTML = "";

    regexBlacklist.forEach((regex, index) => {
      const item = createListItem(
        regex,
        () => {
          regexBlacklist.splice(index, 1);
          saveBlacklists();
          refreshRegexList();
          //BlockCard();
        },
        true
      );
      regexList.appendChild(item);
    });

    Array.from(regexList.children)
      .reverse()
      .forEach((item) => regexList.appendChild(item));

    if (regexBlacklist.length === 0) {
      const empty = document.createElement("div");
      empty.textContent = "æš‚æ— æ­£åˆ™åŒ¹é…å±è”½è§„åˆ™";
      empty.style.textAlign = "center";
      empty.style.padding = "16px";
      empty.style.color = "#999";
      regexList.appendChild(empty);
    }
  }
  // æ›´æ–°tnameåŒ¹é…åˆ—è¡¨
  function refreshTagNameList() {
    if (!tNameList) {
      if (!isBlacklistPanelCreated()) {
        return;
      }
      tNameList = document.querySelector("#bilibili-blacklist-tname-list");
      if (!tNameList) {
        console.warn("[Bilibili-Blacklist] tNameList æœªå®šä¹‰");
        return;
      }
    }
    tNameList.innerHTML = "";

    tNameBlacklist.forEach((tName) => {
      const item = createListItem(tName, () => {
        removeFromTNameBlacklist(tName);
      });
      tNameList.appendChild(item);
    });
    Array.from(tNameList.children)
      .reverse()
      .forEach((item) => tNameList.appendChild(item));

    if (tNameBlacklist.length === 0) {
      const empty = document.createElement("div");
      empty.textContent = "æš‚æ— æ ‡ç­¾å±è”½è§„åˆ™";
      empty.style.textAlign = "center";
      empty.style.padding = "16px";
      empty.style.color = "#999";
      tNameList.appendChild(empty);
    }
  }
  // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºä¸€ä¸ªå¼€å…³æŒ‰é’®
  function createToggleButton(labelText, configKey, title = null) {
    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.alignItems = "center";
    container.style.marginBottom = "8px";
    container.style.gap = "8px";
    container.title = title;
    const label = document.createElement("span");
    label.textContent = labelText;
    label.style.flex = "1";

    const button = document.createElement("button");
    button.style.padding = "6px 12px";
    button.style.border = "none";
    button.style.borderRadius = "4px";
    button.style.cursor = "pointer";
    button.style.color = "#fff";

    function refreshButtonAppearance() {
      button.textContent = globalConfig[configKey] ? "å¼€å¯" : "å…³é—­";
      button.style.backgroundColor = globalConfig[configKey]
        ? "#fb7299"
        : "#909399";
    }

    button.addEventListener("click", () => {
      globalConfig[configKey] = !globalConfig[configKey];
      refreshButtonAppearance();
      saveGlobalConfig(); // ä½ å¯ä»¥å®ç°æ­¤å‡½æ•°ï¼Œå°†globalConfigå­˜å‚¨åˆ°localStorageæˆ–å…¶ä»–
    });

    refreshButtonAppearance();

    container.appendChild(label);
    container.appendChild(button);

    return container;
  }
  // æ›´æ–°é…ç½®åˆ—è¡¨
  function refreshConfigSettings() {
    if (!configList) return;
    // æ¸…ç©º configContent
    configList.innerHTML = "";
    //å¼€å…³
    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.alignItems = "center";
    container.style.marginBottom = "8px";
    container.style.gap = "8px";
    container.style.margin = "20px 0";
    const label = document.createElement("span");
    label.textContent = "ä¸´æ—¶å¼€å…³";
    label.style.flex = "1";
    btnTempUnblock = document.createElement("button");
    btnTempUnblock.textContent = isShowAll ? "æ¢å¤å±è”½" : "å–æ¶ˆå±è”½";
    btnTempUnblock.style.background = isShowAll ? "#dddddd" : "#fb7299";
    btnTempUnblock.style.padding = "6px 12px";
    btnTempUnblock.style.border = "none";
    btnTempUnblock.style.cursor = "pointer";
    btnTempUnblock.style.color = "#fff";
    btnTempUnblock.addEventListener("click", toggleShowAll);
    container.appendChild(label);
    container.appendChild(btnTempUnblock);

    configList.appendChild(container);
    // æ ‡é¢˜
    const title = document.createElement("h4");
    title.textContent = "å…¨å±€é…ç½®å¼€å…³(éƒ¨åˆ†åŠŸèƒ½åˆ·æ–°åç”Ÿæ•ˆ)";
    title.style.fontWeight = "bold";
    title.style.marginBottom = "12px";
    configList.appendChild(title);

    // åˆ›å»ºå¼€å…³
    configList.appendChild(
      createToggleButton("å±è”½æ ‡é¢˜/Upä¸»å", "flagInfo", "å±è”½æ ‡é¢˜/Upä¸»å")
    );
    configList.appendChild(
      createToggleButton("å±è”½åˆ†ç±»æ ‡ç­¾", "flagTName", "é€šè¿‡è¯·æ±‚APIè·å–åˆ†ç±»æ ‡ç­¾")
    );
    configList.appendChild(
      createToggleButton("å±è”½ä¸»é¡µæ¨è", "flagAD", "ç›´æ’­/å¹¿å‘Š/åˆ†åŒºæ¨é€")
    );
    configList.appendChild(
      createToggleButton("å±è”½ä¸»é¡µè§†é¢‘è½¯å¹¿", "flagCM", "cm.bilibili.comè½¯å¹¿")
    );
    configList.appendChild(
      createToggleButton("é®æŒ¡è¢«å±è”½è§†é¢‘", "flagKirby", "æ›´åŠ æ¸©å’Œçš„æ–¹å¼")
    );
    // å¤„ç†é˜Ÿåˆ—è¯·æ±‚é—´éš”
    const intervalContainer = document.createElement("div");
    intervalContainer.style.display = "flex";
    intervalContainer.style.alignItems = "center";
    intervalContainer.style.marginTop = "16px";
    intervalContainer.style.gap = "8px";
    intervalContainer.title =
      "è¯·æ±‚APIé—´éš”æ—¶é—´ï¼Œé—´éš”æ—¶é—´è¶Šé•¿ï¼Œå±è”½è¶Šå¿«ï¼Œè¯·æ±‚é¢‘ç¹å¯ä»¥ä¼šè¢«ä¸´æ—¶banï¼Œå»ºè®®å€¼ 100ms";

    const intervalLabel = document.createElement("span");
    intervalLabel.textContent = "è§†é¢‘åˆ†ç±»-å¤„ç†é˜Ÿåˆ—è¯·æ±‚é—´éš” (ms):";

    intervalLabel.style.flex = "1";

    const intervalInput = document.createElement("input");
    intervalInput.type = "number";
    intervalInput.min = "0";
    intervalInput.value = globalConfig.processQueueInterval;
    intervalInput.style.width = "100px";
    intervalInput.style.padding = "6px";
    intervalInput.style.border = "1px solid #ddd";
    intervalInput.style.borderRadius = "4px";

    const saveIntervalBtn = document.createElement("button");
    saveIntervalBtn.textContent = "ä¿å­˜";
    saveIntervalBtn.style.padding = "6px 12px";
    saveIntervalBtn.style.backgroundColor = "#fb7299";
    saveIntervalBtn.style.color = "#fff";
    saveIntervalBtn.style.border = "none";
    saveIntervalBtn.style.borderRadius = "4px";
    saveIntervalBtn.style.cursor = "pointer";

    saveIntervalBtn.addEventListener("click", () => {
      const val = parseInt(intervalInput.value, 10);
      if (!isNaN(val) && val >= 0) {
        globalConfig.processQueueInterval = val;
        saveGlobalConfig(); // ä¿å­˜é…ç½®
        //alert("å¤„ç†é˜Ÿåˆ—è¯·æ±‚é—´éš”å·²ä¿å­˜ï¼");
      } else {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„éè´Ÿæ•°å­—ï¼");
      }
    });

    intervalContainer.appendChild(intervalLabel);
    intervalContainer.appendChild(intervalInput);
    intervalContainer.appendChild(saveIntervalBtn);
    configList.appendChild(intervalContainer);
    return configList;
  }
  function refreshAllTabs() {
    refreshExactList();
    refreshRegexList();
    refreshTagNameList();
    refreshConfigSettings();
  }
  function isBlacklistPanelCreated() {
    const panelInDom = document.querySelector(
      "#bilibili-blacklist-manager-panel"
    );
    if (panelInDom) {
      if (!managerPanel) {
        managerPanel = panelInDom;
      }
      return true;
    }
    return false;
  }
  // åˆ›å»ºé»‘åå•é¢æ¿
  function createBlacklistPanel() {
    if (isBlacklistPanelCreated()) {
      return;
    }
    managerPanel = document.createElement("div");
    managerPanel.id = "bilibili-blacklist-panel";

    managerPanel.style.position = "fixed";
    managerPanel.style.top = "50%";
    managerPanel.style.left = "50%";
    managerPanel.style.transform = "translate(-50%, -50%)";
    managerPanel.style.width = "500px";
    managerPanel.style.maxHeight = "80vh";
    managerPanel.style.backgroundColor = "#fff";
    managerPanel.style.borderRadius = "8px";
    managerPanel.style.boxShadow = "0 4px 12px rgba(0, 0, 0, 0.15)";
    managerPanel.style.zIndex = "99999";
    managerPanel.style.overflow = "hidden";
    managerPanel.style.display = "none";
    managerPanel.style.flexDirection = "column";
    managerPanel.style.backgroundColor = "#ffffffee";

    const tabContainer = document.createElement("div");
    tabContainer.style.display = "flex";
    tabContainer.style.borderBottom = "1px solid #f1f2f3";

    // å†…å®¹åŒº
    const exactContent = document.createElement("div");
    exactContent.style.padding = "16px";
    exactContent.style.overflowY = "auto";
    exactContent.style.flex = "1";
    exactContent.style.display = "block";

    const regexContent = document.createElement("div");
    regexContent.style.padding = "16px";
    regexContent.style.overflowY = "auto";
    regexContent.style.flex = "1";
    regexContent.style.display = "none";

    const tnameContent = document.createElement("div");
    tnameContent.style.padding = "16px";
    tnameContent.style.overflowY = "auto";
    tnameContent.style.flex = "1";
    tnameContent.style.display = "none";

    const configContent = document.createElement("div");
    configContent.style.padding = "16px";
    configContent.style.overflowY = "auto";
    configContent.style.flex = "1";
    configContent.style.display = "none";
    const tabs = [
      { name: "ç²¾ç¡®åŒ¹é…(Upåå­—)", content: exactContent },
      { name: "æ­£åˆ™åŒ¹é…(Up/æ ‡é¢˜)", content: regexContent },
      { name: "å±è”½åˆ†ç±»", content: tnameContent },
      { name: "æ’ä»¶é…ç½®", content: configContent },
    ];
    tabs.forEach((tabData) => {
      const tab = document.createElement("div");
      tab.textContent = tabData.name;
      tab.style.padding = "12px 16px";
      tab.style.cursor = "pointer";
      tab.style.fontWeight = "500";
      tab.style.borderBottom =
        tabData.content.style.display === "block"
          ? "2px solid #fb7299"
          : "none";

      tab.addEventListener("click", () => {
        tabs.forEach(({ tab: t, content: c }) => {
          t.style.borderBottom = "none";
          c.style.display = "none";
        });
        tab.style.borderBottom = "2px solid #fb7299";
        tabData.content.style.display = "block";
      });

      tabData.tab = tab;
      tabContainer.appendChild(tab);
    });
    // Header åŒºåŸŸ
    const header = document.createElement("div");
    header.style.padding = "16px";
    header.style.borderBottom = "1px solid #f1f2f3";
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";

    blockTitle = document.createElement("h3");
    blockTitle.style.margin = "0";
    blockTitle.style.fontWeight = "500";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Ã—";
    closeBtn.style.background = "none";
    closeBtn.style.border = "none";
    closeBtn.style.cursor = "pointer";
    closeBtn.style.padding = "0 8px";
    closeBtn.addEventListener("click", () => {
      managerPanel.style.display = "none";
    });

    header.appendChild(blockTitle);
    header.appendChild(closeBtn);
    const contentContainer = document.createElement("div");
    contentContainer.style.display = "flex";
    contentContainer.style.flexDirection = "column";
    contentContainer.style.flex = "1";
    contentContainer.style.overflow = "hidden";

    // ç²¾ç¡®åŒ¹é…è¾“å…¥æ¡†
    const addExactContainer = document.createElement("div");
    addExactContainer.style.display = "flex";
    addExactContainer.style.marginBottom = "16px";
    addExactContainer.style.gap = "8px";

    const exactInput = document.createElement("input");
    exactInput.type = "text";
    exactInput.placeholder = "è¾“å…¥è¦å±è”½çš„UPä¸»åç§°";
    exactInput.style.flex = "1";
    exactInput.style.padding = "8px";
    exactInput.style.border = "1px solid #ddd";
    exactInput.style.borderRadius = "4px";

    const addExactBtn = document.createElement("button");
    addExactBtn.textContent = "æ·»åŠ ";
    addExactBtn.style.padding = "8px 16px";
    addExactBtn.style.background = "#fb7299";
    addExactBtn.style.color = "#fff";
    addExactBtn.style.border = "none";
    addExactBtn.style.borderRadius = "4px";
    addExactBtn.style.cursor = "pointer";
    addExactBtn.addEventListener("click", () => {
      const upName = exactInput.value.trim();
      if (upName) {
        addToExactBlacklist(upName);
        exactInput.value = "";
      }
    });
    addExactContainer.appendChild(exactInput);
    addExactContainer.appendChild(addExactBtn);
    exactContent.appendChild(addExactContainer);
    // æ­£åˆ™åŒ¹é…è¾“å…¥æ¡†
    const addRegexContainer = document.createElement("div");
    addRegexContainer.style.display = "flex";
    addRegexContainer.style.marginBottom = "16px";
    addRegexContainer.style.gap = "8px";

    const regexInput = document.createElement("input");
    regexInput.type = "text";
    regexInput.placeholder = "è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼ (å¦‚: å°å°.*Official)";
    regexInput.style.flex = "1";
    regexInput.style.padding = "8px";
    regexInput.style.border = "1px solid #ddd";
    regexInput.style.borderRadius = "4px";

    const addRegexBtn = document.createElement("button");
    addRegexBtn.textContent = "æ·»åŠ ";
    addRegexBtn.style.padding = "8px 16px";
    addRegexBtn.style.background = "#fb7299";
    addRegexBtn.style.color = "#fff";
    addRegexBtn.style.border = "none";
    addRegexBtn.style.borderRadius = "4px";
    addRegexBtn.style.cursor = "pointer";
    addRegexBtn.addEventListener("click", () => {
      const regex = regexInput.value.trim();
      if (regex && !regexBlacklist.includes(regex)) {
        try {
          new RegExp(regex);
          regexBlacklist.push(regex);
          saveBlacklists();
          regexInput.value = "";
          refreshRegexList();
          //BlockCard();
        } catch (e) {
          alert("æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼: " + e.message);
        }
      }
    });
    addRegexContainer.appendChild(regexInput);
    addRegexContainer.appendChild(addRegexBtn);
    regexContent.appendChild(addRegexContainer);
    // ç²¾ç¡®åŒ¹é…åˆ—è¡¨
    exactList = document.createElement("ul");
    exactList.id = "bilibili-blacklist-exact-list";
    exactList.style.listStyle = "none";
    exactList.style.padding = "0";
    exactList.style.margin = "0";

    // æ­£åˆ™åŒ¹é…åˆ—è¡¨
    regexList = document.createElement("ul");
    regexList.id = "bilibili-blacklist-regex-list";
    regexList.style.listStyle = "none";
    regexList.style.padding = "0";
    regexList.style.margin = "0";
    // tnameåˆ—è¡¨
    tNameList = document.createElement("ul");
    tNameList.id = "bilibili-blacklist-tname-list";
    tNameList.style.listStyle = "none";
    tNameList.style.padding = "0";
    tNameList.style.margin = "0";

    // é…ç½®åˆ—è¡¨
    configList = document.createElement("ul");
    configList.id = "bilibili-blacklist-config-list";
    configList.style.listStyle = "none";
    configList.style.padding = "0";
    configList.style.margin = "0";

    // æ›´æ–°åˆ—è¡¨
    refreshAllTabs();
    exactContent.appendChild(exactList);
    regexContent.appendChild(regexList);
    tnameContent.appendChild(tNameList);
    configContent.appendChild(configList);
    contentContainer.appendChild(exactContent);
    contentContainer.appendChild(regexContent);
    contentContainer.appendChild(tnameContent);
    contentContainer.appendChild(configContent);

    managerPanel.appendChild(tabContainer);
    managerPanel.appendChild(header);
    managerPanel.appendChild(contentContainer);

    document.body.appendChild(managerPanel);
    return managerPanel;
  }

  // æ·»åŠ å…¨å±€æ ·å¼
  GM_addStyle(`
        .bilibili-blacklist-block-container {
          display: none;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 20px;
          margin-top: 5px;
          padding: 0 5px;
          font-size: 12px;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          gap: 3px;
          z-index: 9999;
          pointer-events: none;
          text-align:center;

      }

      .bili-video-card:hover .bilibili-blacklist-block-container,
      .card-box:hover .bilibili-blacklist-block-container {
          display: flex !important;
          pointer-events: none;
      }
      .card-box .bilibili-blacklist-block-container
      {
        flex-direction: column;
        align-items: flex-start;
        height: 100%;
      }
      .card-box .bilibili-blacklist-tname-group
      {
        flex-direction: column;
        align-items: flex-end;
        bottom: 0;
      }
      .card-box .bilibili-blacklist-tname-group .bilibili-blacklist-tname
      {
        background-color:rgba(255, 255, 255, 0.87);
        color: #9499A0;
        border: 1px solid #9499A0;
      }

      .bilibili-blacklist-block-btn {
          position: static;
          display: flex;
          width: 40px;
          height: 20px;
          justify-content: center;
          align-items: center;
          pointer-events: auto !important;
          background-color: #fb7299dd;
          color: white;
          border-radius: 10%;
          cursor: pointer;
          text-align: center;
      }

      .bilibili-blacklist-tname-group {
          display: flex;
          flex-direction: row;
          padding:0 5px;
          gap: 3px;
          align-items: center;
          margin-left: auto;
          max-width: 80%;
          pointer-events: none;
      }

      .bilibili-blacklist-tname {
          background-color: #fb7299dd;
          color: white;
          height: 20px;
          padding: 0 5px;
          border-radius: 10%;
          cursor: pointer;
          border-radius: 2px;
          pointer-events: auto;
          text-align: center;
          display: flex;
          justify-content: center;
          align-items: center;
          text-overflow: ellipsis;
          overflow: hidden;
          white-space: nowrap;
        }


        /* ä¿®å¤è§†é¢‘å¡ç‰‡å¸ƒå±€ */
        .bili-video-card__cover {
            contain: layout !important;
        }
        /* é¢æ¿æ ·å¼ */
        #bilibili-blacklist-panel {
            font-size: 15px;
        }
        /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #bilibili-blacklist-panel button {
            transition: background-color 0.2s;
        }
        #bilibili-blacklist-panel button:hover {
            opacity: 0.9;
        }
        /* ç®¡ç†æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #bilibili-blacklist-manager:hover svg {
            transform: scale(1.1);
        }
        #bilibili-blacklist-manager svg {
            transition: transform 0.2s;
        }
        /* è¾“å…¥æ¡†èšç„¦æ•ˆæœ */
        #bilibili-blacklist-panel input:focus {
            outline: none;
            border-color: #fb7299 !important;
        }
        /*ç°åº¦æ•ˆæœ*/
        .bilibili-blacklist-grayscale {
           filter: grayscale(95%);
        }


    `);
  //å¯çˆ±çš„å¡æ¯”å›¾æ ‡
  function getKirbySVG() {
    return `
        <svg width="35" height="35" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"  >
            <ellipse cx="70" cy="160" rx="30" ry="15" fill="#cc3333" />
            <ellipse cx="130" cy="160" rx="30" ry="15" fill="#cc3333" />
            <ellipse cx="50" cy="120" rx="20" ry="20" fill="#ffb6c1" />
            <ellipse cx="150" cy="120" rx="20" ry="20" fill="#ffb6c1" />
            <circle cx="100" cy="110" r="60" fill="#ffb6c1" />
            <ellipse cx="80" cy="90" rx="10" ry="22" fill="blue" />
            <ellipse cx="80" cy="88" rx="10" ry="15" fill="black" />
            <ellipse cx="80" cy="82" rx="8" ry="12" fill="#ffffff" />
            <ellipse cx="80" cy="90" rx="10" ry="22" fill="#00000000" stroke="#000000" strokeWidth="4" />
            <ellipse cx="120" cy="90" rx="10" ry="22" fill="blue" />
            <ellipse cx="120" cy="88" rx="10" ry="15" fill="black" />
            <ellipse cx="120" cy="82" rx="8" ry="12" fill="#ffffff" />
            <ellipse cx="120" cy="90" rx="10" ry="22" fill="#00000000" stroke="#000000" strokeWidth="4" />
            <ellipse cx="60" cy="110" rx="8" ry="5" fill="#ff4466" />
            <ellipse cx="140" cy="110" rx="8" ry="5" fill="#ff4466" />
            <path d="M 90 118 Q 100 125, 110 118" stroke="black" strokeWidth="3" fill="transparent" />
        </svg>
    `;
  }
  // æ·»åŠ å¡æ¯”è¦†ç›–å›¾å±‚åˆ°æŒ‡å®šå¡ç‰‡ä¸Š
  function addKirbyOverlay(card, invert = false) {
    const kirbyWrapper = document.createElement("div");
    if (card.querySelector("#bilibili-blacklist-kirby") != null) return;
    kirbyWrapper.innerHTML = getKirbySVG();
    kirbyWrapper.id = "bilibili-blacklist-kirby";
    // è®¾ç½®æ•´ä½“é®ç½©æ ·å¼ï¼ˆèƒŒæ™¯ + æ¯›ç»ç’ƒï¼‰
    const justifyContent = isVideoPage() ? "flex-start" : "center";
    const alignItems = isVideoPage() ? "flex-start" : "center";
    Object.assign(kirbyWrapper.style, {
      position: "absolute",
      top: "0",
      left: "0",
      width: "100%",
      height: "100%",
      pointerEvents: "none",
      display: "flex",
      justifyContent: `${justifyContent}`,
      alignItems: `${alignItems}`,
      zIndex: "10",
      backgroundColor: "rgba(255, 255, 255, 0.5)", // èƒŒæ™¯
      backdropFilter: "blur(2px)",
      WebkitBackdropFilter: "blur(2px)",
      borderRadius: "inherit",
      border: "1px solid rgba(255, 255, 255, 0.5)",
    });

    const svg = kirbyWrapper.querySelector("svg");
    if (svg) {
      const cardRect = card.getBoundingClientRect();
      const size = Math.min(cardRect.width, cardRect.height) * 1.0;
      svg.setAttribute("width", `${size}px`);
      svg.setAttribute("height", `${size}px`);
      svg.setAttribute("bottom", `${cardRect.height - size}px`);
      // è®¾ç½®å¡æ¯”å›¾æ ‡æœ¬èº«æ ·å¼ï¼ˆå¯åè‰² + åŠé€æ˜ï¼‰
      svg.style.opacity = "0.15"; // ä»…å›¾æ ‡æœ¬ä½“åŠé€æ˜
      svg.style.filter = invert ? "invert(1)" : "none";
      if (isVideoPage()) {
        svg.style.marginTop = "-10px";
      } else {
        svg.style.marginTop = "-40px";
      }
    }

    const cardStyle = getComputedStyle(card);
    if (cardStyle.position === "static" || !cardStyle.position) {
      card.style.position = "relative";
    }

    card.appendChild(kirbyWrapper);
  }
  function removeKirbyOverlay(card) {
    const kirbyWrapper = card.querySelector("#bilibili-blacklist-kirby");
    if (kirbyWrapper) {
      kirbyWrapper.remove();
    }
  }
  //#endregion
  //##########################

  //#region è§‚å¯Ÿè€…
  let obsTimeout = 1000;
  // MutationObserver æ£€æµ‹åŠ¨æ€åŠ è½½çš„æ–°å†…å®¹ï¼ˆä»…å½“èŠ‚ç‚¹å¯è§æ—¶æ‰è§¦å‘ï¼‰
  const observer = new MutationObserver((mutations) => {
    let shouldCheck = false;
    if (isVideoPage()) {
      mutations.forEach((mutation) => {
        if (mutation.addedNodes.length > 0) {
          // æ£€æŸ¥æ–°å¢èŠ‚ç‚¹æ˜¯å¦å¯è§ï¼ˆæœ‰å®½åº¦æˆ–é«˜åº¦ï¼‰
          shouldCheck = Array.from(mutation.addedNodes).some((node) => {
            // ä»…æ£€æŸ¥å…ƒç´ èŠ‚ç‚¹ï¼ˆè·³è¿‡æ–‡æœ¬èŠ‚ç‚¹ã€æ³¨é‡Šç­‰ï¼‰
            if (node.nodeType !== Node.ELEMENT_NODE) return false;

            // æ£€æŸ¥å…ƒç´ æˆ–å…¶å­å…ƒç´ æ˜¯å¦å¯è§
            const hasVisibleContent =
              node.offsetWidth > 0 ||
              node.offsetHeight > 0 ||
              node.querySelector("[offsetWidth], [offsetHeight]");

            return hasVisibleContent;
          });
        }
      });
    } else {
      mutations.forEach((mutation) => {
        if (mutation.addedNodes.length > 0) {
          shouldCheck = true;
        }
      });
    }

    // å¦‚æœæœ‰å¯è§çš„æ–°å†…å®¹ï¼Œå»¶è¿Ÿ 1 ç§’åæ‰§è¡Œå±è”½ï¼ˆç¡®ä¿ DOM å®Œå…¨æ¸²æŸ“ï¼‰
    if (shouldCheck) {
      processedCards = new WeakSet(); // é‡ç½®å·²å¤„ç†å¡ç‰‡é›†åˆ
      setTimeout(() => {
        BlockCard();
        //addBlacklistManagerButton(); // ç¡®ä¿æ¯æ¬¡éƒ½æ·»åŠ é»‘åå•ç®¡ç†æŒ‰é’®
        if (isMainPage()) {
          BlockMainAD(); // å±è”½é¡µé¢å¹¿å‘Š
        }
        if (isVideoPage()) {
          BlockVideoPageAd(); // å±è”½è§†é¢‘é¡µé¢å¹¿å‘Š
        }
        if (!document.getElementById("bilibili-blacklist-manager")) {
          addBlacklistManagerButton();
        }

        if (obsTimeout <= 10) {
          obsTimeout = 10; // è®¾ç½®æœ€å°è¶…æ—¶æ—¶é—´
        } else {
          obsTimeout /= 2; // é€’å‡è¶…æ—¶æ—¶é—´
        }
      }, obsTimeout);
    }
  });

  // åˆå§‹åŒ–è§‚å¯Ÿè€…ï¼ˆç›‘è§† DOM å˜åŒ–ï¼‰
  let observerError = 0;
  function initObserver(container) {
    const rootNode =
      document.getElementById(container) ||
      document.querySelector(container) ||
      document.documentElement; // å›é€€åˆ°æ•´ä¸ªæ–‡æ¡£

    if (rootNode) {
      observer.observe(rootNode, {
        childList: true, // ç›‘è§†æ·»åŠ /ç§»é™¤çš„èŠ‚ç‚¹
        subtree: true, // ç›‘è§†æ‰€æœ‰åä»£
      });
      return true;
    } else {
      // å¦‚æœæ²¡æ‰¾åˆ°æ ¹èŠ‚ç‚¹åˆ™é‡è¯•
      setTimeout(() => initObserver(container), 500);
      console.warn("[bilibili-blacklist] æœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œæ­£åœ¨é‡è¯•...");
      observerError++;

      if (observerError > 10) {
        console.error("[bilibili-blacklist] é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œåœæ­¢é‡è¯•ã€‚");
        return false;
      }
    }
  }
  //#endregion
  //#region åˆå§‹åŒ–å‡½æ•°

  let isInit = false; // æ˜¯å¦å·²ç»åˆå§‹åŒ–
  function init() {
    // é‡ç½®çŠ¶æ€
    //if (isInit) return;
    isBlocking = false;
    lastBlockTime = 0;
    blockedCards = new Set(); // ä½¿ç”¨ Set å­˜å‚¨å·²å±è”½çš„å¡ç‰‡
    processedCards = new WeakSet();
    cardSequenceGetJson = new Set();
    if (isMainPage()) {
      initMainPage(); // åˆå§‹åŒ–ä¸»é¡µ
      BlockMainAD(); // å±è”½ä¸»é¡µå¹¿å‘Š
    } else if (isSearchPage()) {
      initSearchPage(); // åˆå§‹åŒ–æœç´¢é¡µ
    } else if (isVideoPage()) {
      initVideoPage(); // åˆå§‹åŒ–æ’­æ”¾é¡µ
      //BlockVideoPageAd(); // å±è”½è§†é¢‘é¡µé¢å¹¿å‘Š
    } else if (isCategoryPage()) {
      initCategoryPage(); // åˆå§‹åŒ–åˆ†ç±»é¡µ
    } else if (isUserSpace()) {
      initUserSpace(); // åˆå§‹åŒ–ç”¨æˆ·ç©ºé—´
      //return; // ç”¨æˆ·ç©ºé—´ä¸éœ€è¦å±è”½
    } else {
      return; // å¦‚æœä¸æ˜¯å·²çŸ¥é¡µé¢åˆ™ä¸æ‰§è¡Œ
    }
    BlockCard(); // åˆå§‹åŒ–æ—¶ç«‹å³æ‰§è¡Œå±è”½
    addBlacklistManagerButton(); // æ·»åŠ é»‘åå•ç®¡ç†æŒ‰é’®
    createBlacklistPanel();
    isInit = true;
    console.log("[bilibili-blacklist] è„šæœ¬å·²åŠ è½½ğŸ¥”");
  }
  // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆäº‹ä»¶
  document.addEventListener("DOMContentLoaded", init);
  if (
    document.readyState === "complete" ||
    document.readyState === "interactive"
  ) {
    init();
  }
  // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦ä¸ºBç«™ä¸»é¡µ
  function isMainPage() {
    return location.pathname === "/";
  }

  function initMainPage() {
    initObserver("i_cecream"); // ä¼ å…¥Bç«™ä¸»é¡µçš„ä¸»å®¹å™¨ID
    console.log("[bilibili-blacklist] ä¸»é¡µå·²åŠ è½½ğŸ“");
  }
  /// -----æœç´¢é¡µ----
  function isSearchPage() {
    return location.hostname === "search.bilibili.com";
  }
  function initSearchPage() {
    initObserver("i_cecream");
    console.log("[bilibili-blacklist] æœç´¢é¡µå·²åŠ è½½ğŸ‰");
  }
  /// --- æ’­æ”¾é¡µ ---
  function isVideoPage() {
    return location.pathname.startsWith("/video/");
  }
  function initVideoPage() {
    initObserver("rcmd-tab");
    console.log("[bilibili-blacklist] æ’­æ”¾é¡µå·²åŠ è½½ğŸ‡");
  }
  // ---- åˆ†ç±»é¡µ ----
  function isCategoryPage() {
    return location.pathname.startsWith("/c/");
  }
  function initCategoryPage() {
    initObserver("win");
    console.log("[bilibili-blacklist] åˆ†ç±»é¡µå·²åŠ è½½ğŸŠ");
  }
  ///---ç”¨æˆ·ç©ºé—´---
  function isUserSpace() {
    return location.hostname === "space.bilibili.com";
  }
  function initUserSpace() {
    console.log("[bilibili-blacklist] ç”¨æˆ·ç©ºé—´å·²åŠ è½½ğŸ");
    const upNameSelector = "#h-name, .nickname";
    const observerForUpName = new MutationObserver((mutations, observer) => {
      const upNameElement = document.querySelector(upNameSelector);
      if (upNameElement) {
        observer.disconnect();
        addBlockButtonToUserSpace(upNameElement);
      }
    });

    observerForUpName.observe(document.body, {
      childList: true,
      subtree: true,
    });
    const initialUpNameElement = document.querySelector(upNameSelector);
    if (initialUpNameElement) {
      observerForUpName.disconnect();
      addBlockButtonToUserSpace(initialUpNameElement);
    }
  }

  function addBlockButtonToUserSpace(upNameElement) {
    const upName = upNameElement.textContent.trim();
    //console.log(`å½“å‰ç”¨æˆ·æ˜µç§°: ${upName}`);
    if (upNameElement.querySelector(".bilibili-blacklist-up-block-btn")) {
      return;
    }
    // è®¾ç½® inline-flexï¼Œè®©æ–‡å­—å’ŒæŒ‰é’®ä¸€è¡Œæ˜¾ç¤º
    upNameElement.style.display = "inline-flex";
    upNameElement.style.alignItems = "center";

    const button = document.createElement("button");
    button.className = "bilibili-blacklist-up-block-btn";
    button.textContent = "å±è”½";
    button.style.color = "#fff";
    button.style.width = "100px";
    button.style.height = "30px";
    button.style.marginLeft = "10px";
    button.style.borderRadius = "5px";
    button.style.border = "1px solid #fb7299";

    const refreshButtonStatus = () => {
      const blocked = isBlacklisted(upName);
      if (blocked) {
        button.textContent = "å·²å±è”½";
        button.style.backgroundColor = "#dddddd";
        button.style.border = "1px solid #ccc";
        upNameElement.style.textDecoration = "line-through"; // æ·»åŠ åˆ é™¤çº¿æ•ˆæœ
        document.body.classList.add("bilibili-blacklist-grayscale");
      } else {
        button.textContent = "å±è”½";
        button.style.backgroundColor = "#fb7299";
        button.style.border = "1px solid #fb7299";
        upNameElement.style.textDecoration = "none"; // ç§»é™¤åˆ é™¤çº¿æ•ˆæœ
        document.body.classList.remove("bilibili-blacklist-grayscale");
      }
    };

    button.addEventListener("click", (e) => {
      e.stopPropagation();
      const blocked = isBlacklisted(upName);
      if (blocked) {
        removeFromExactBlacklist(upName);
      } else {
        addToExactBlacklist(upName);
      }
      refreshButtonStatus();
    });

    refreshButtonStatus(); // Set initial button state

    upNameElement.appendChild(button);
  }
  //#endregion

  //#region é¢å¤–åŠŸèƒ½-å±è”½å¹¿å‘Š
  // å±è”½å¹¿å‘Š
  function BlockMainAD() {
    if (!globalConfig.flagAD) return;
    const adSelectors = [
      ".floor-single-card", // åˆ†åŒºæ¨è
      ".bili-live-card", // ç›´æ’­æ¨å¹¿
      ".btn-ad", // å¹¿å‘ŠæŒ‰é’®
    ];
    adSelectors.forEach((selector) => {
      document.querySelectorAll(selector).forEach((adCard) => {
        //adCard.remove();
        hideCard(adCard);
      });
    });
  }

  // å±è”½è§†é¢‘é¡µé¢å¹¿å‘Šï¼ˆä½¿ç”¨æ•°ç»„ä¼˜åŒ–ï¼‰
  function BlockVideoPageAd() {
    if (!globalConfig.flagAD) return;
    const adSelectors = [
      ".video-card-ad-small", // å³ä¸Šè§’æ¨å¹¿
      ".slide-ad-exp", // å¤§æ¨å¹¿
      ".video-page-game-card-small", // æ¸¸æˆæ¨å¹¿
      ".activity-m-v1", // æ´»åŠ¨æ¨å¹¿
      ".video-page-special-card-small", // ç‰¹æ®Šå¡ç‰‡æ¨å¹¿
      ".ad-floor-exp", // å¹¿å‘Šåœ°æ¿
      ".btn-ad", // å¹¿å‘ŠæŒ‰é’®
    ];

    adSelectors.forEach((selector) => {
      document.querySelectorAll(selector).forEach((adCard) => {
        //adCard.remove();
        hideCard(adCard);
      });
    });
  }
  //#endregion
})();
