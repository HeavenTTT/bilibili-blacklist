# Bilibili-BlackList 重构说明

## 项目重构概述

本项目已从单一文件重构为模块化结构，以提高代码可维护性和可读性。

## 重构前后的对比

### 重构前
- 单一文件：`scripts/bilibili-blacklist.user.js`
- 代码结构：所有功能混合在一个文件中
- 维护难度：较高

### 重构后
- 模块化结构：分离为多个功能模块
- 代码结构：清晰的功能划分
- 维护难度：较低

## 模块结构

```
src/
├── storage.js          # 存储管理模块
├── core.js             # 核心功能模块
├── video_data.js       # 视频数据获取模块
├── ui.js               # UI元素模块
├── page_detection.js   # 页面检测和初始化模块
├── ad_blocker.js       # 广告屏蔽模块
└── main.js             # 主入口文件
```

### 各模块功能说明

1. **storage.js**：负责数据存储和配置管理
   - 黑名单管理（精确匹配、正则匹配、标签名）
   - 全局配置管理

2. **core.js**：核心屏蔽逻辑
   - 视频卡片处理
   - 屏蔽算法
   - 队列处理

3. **video_data.js**：视频数据获取
   - API调用
   - BV号提取
   - 视频信息获取

4. **ui.js**：用户界面组件
   - 管理面板
   - 按钮创建
   - 样式定义

5. **page_detection.js**：页面检测和初始化
   - 页面类型检测
   - MutationObserver管理
   - 页面特定初始化

6. **ad_blocker.js**：广告屏蔽功能
   - 主页广告屏蔽
   - 播放页广告屏蔽

7. **main.js**：主入口文件
   - 模块导入
   - 初始化逻辑

## 构建脚本

### 自动整合脚本
位于 `scripts/build-bilibili-blacklist.sh`，可自动将所有模块合并为单个用户脚本。

使用方法：
```bash
cd scripts
./build-bilibili-blacklist.sh
```

### 构建输出
- `scripts/bilibili-blacklist.user.js` - 重构后的完整脚本

## 功能保留

重构后保留了原脚本的所有功能：
- ✅ 视频卡片屏蔽，支持主页/播放页/分类页/搜索页
- ✅ 用户空间支持，直接屏蔽当前访问的UP主
- ✅ 精确匹配黑名单（UP主名称匹配）
- ✅ 正则匹配黑名单（UP主/视频标题匹配）
- ✅ 黑名单管理面板，支持一键添加/移除
- ✅ 已屏蔽视频计数展示
- ✅ 广告屏蔽
- ✅ 自动适配动态内容加载
- ✅ 卡比覆盖模式

## 维护建议

1. **新增功能**：在对应模块中添加，保持模块职责单一
2. **修改功能**：定位到具体模块进行修改
3. **调试**：可单独测试各模块功能
4. **构建**：修改源码后需运行构建脚本生成最终用户脚本

## 注意事项

- 重构后的脚本功能与原版完全一致
- 构建后的脚本可直接用于Tampermonkey等用户脚本管理器
- 源码模块仅供开发维护使用，用户应使用构建后的脚本
- 构建脚本会自动添加必要的用户脚本头部信息（@metadata块）